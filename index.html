<!doctype html>
<html lang="de">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WSA Elbe ‚Äì Monatstabelle</title>

  <link rel="icon" type="image/png" href="https://www.wsa-elbe.wsv.de/SiteGlobals/Frontend/Webs/WNA-WSA/Images/logo.png?__blob=normal&v=2">
  <link rel="stylesheet" href="style.css">

  <!-- XLSX zuerst -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

  <!-- ExcelJS nur n√∂tig f√ºr Export/Backups -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js" defer></script>

  <!-- Dein bestehender Code -->
  <script src="./script.js" defer></script>
</head>

<body>

  <!-- #region 1) LIGHTBOX (Bild-Viewer) ------------------------------------ -->
  <div id="imgLightbox">
    <img alt="Vorschau">
  </div>
  <!-- #endregion -->

  <!-- #region 2) PASSWORT-MODAL ------------------------------------------- -->
  <div id="passwortModal" class="modal">
    <div class="modal-content" style="max-width:400px;text-align:center;">
      <h2>Passwort eingeben</h2>
      <input type="password" id="passwortEingabe" placeholder="Passwort"
        style="padding:10px 14px;font-size:16px;border:1px solid #ccc;border-radius:6px;width:80%;margin-top:10px;">
      <div id="passwortFehler"
        style="color:#dc3545;font-weight:600;margin-top:12px;display:none;animation:fadeIn .3s ease;">
        ‚ùå Falsches Passwort
      </div>
      <div style="margin-top:20px;">
        <button id="passwortOk"
          style="background:#198754;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;">Best√§tigen</button>
        <button id="passwortCancel"
          style="background:#dc3545;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;margin-left:10px;">Abbrechen</button>
      </div>
    </div>
  </div>
  <!-- #endregion -->

  <!-- #region 3) LEGENDE (Farben + Fahrzeug-Legende) ----------------------- -->
  <div class="legend-card" aria-label="Legende">
    <div class="legend-item">
      <span class="legend-swatch legend-weekend" aria-hidden="true"></span> Wochenende
    </div>
    <div class="legend-item">
      <span class="legend-swatch legend-holiday" aria-hidden="true"></span> Feiertag
    </div>
  </div>
  <div id="vehicleLegend" class="vehicle-legend"></div>
  <!-- #endregion -->

  <!-- #region 4) RECHTE BUTTONS (Export/Import/Top) ------------------------ -->
  <div class="export-buttons">
    <button id="importXlsxBtn" class="btn btn--excel-import editor-only" type="button">Excel <br> importieren</button>
    <button id="exportXlsxBtn" data-cancel-edits>Excel exportieren</button>
    <button id="chooseBackupFolderBtn">Backup-Ordner w√§hlen</button>
    <button id="restoreBackupBtn">Backup wiederherstellen</button>
    <button id="backToTop" data-cancel-edits>Zum Seitenanfang</button>
  </div>
  <!-- #endregion -->

  <!-- #region 5) TITEL / STATUS-BADGE -------------------------------------- -->
  <h1>
    Tabelle f√ºr <span id="monatName"></span>
    <span id="statusAnzeige"
      style="margin-left:20px;padding:4px 10px;border-radius:6px;color:black;background-color:rgb(253,17,17);">
      Gesperrt
    </span>
  </h1>
  <!-- #endregion -->

  <!-- #region 6) FILTER (Monat / Jahr / Anzeigen) -------------------------- -->
  <div class="controls">
    <label for="monat">Monat:</label>
    <select id="monat">
      <option value="-1">Alle Monate</option>
      <option value="0">Januar</option>
      <option value="1">Februar</option>
      <option value="2">M√§rz</option>
      <option value="3">April</option>
      <option value="4">Mai</option>
      <option value="5">Juni</option>
      <option value="6">Juli</option>
      <option value="7">August</option>
      <option value="8">September</option>
      <option value="9">Oktober</option>
      <option value="10">November</option>
      <option value="11">Dezember</option>
    </select>

    <label for="jahr">Jahr:</label>
    <select id="jahr" style="width:110px"></select>
  </div>
  <!-- #endregion -->

  <!-- #region 7) LOCKBAR (Sperren / Entsperren) ---------------------------- -->
  <div class="lockbar">
    <span id="lockBadge" class="badge locked">Gesperrt ‚Äì nur Lesen</span>
    <button id="unlockBtn" type="button">Bearbeiten entsperren</button>
    <button id="lockBtn" data-cancel-edits>üîí Sperren</button>
  </div>
  <div class="readonly-hint">Zum Bearbeiten entsperren und Passwort eingeben.</div>
  <!-- #endregion -->

  <!-- #region 8) HAUPTTABELLE ---------------------------------------------- -->
  <div class="table-wrap">
    <table id="monatsTabelle">
      <colgroup id="colgroup-monat">
        <col class="col--tag">
        <col class="col--fahrzeug">
        <col class="col--dienstposten">
        <col class="col--ort">
        <col class="col--von">
        <col class="col--bis">
        <col class="col--bemerkung">
        <col class="col--eingetragen">
      </colgroup>
      <thead>
        <tr>
          <th>Tag</th>
          <th>Fahrzeug</th>
          <th>Dienstposten</th>
          <th class="ort-cell">Ort</th>
          <th>Von (Zeit)</th>
          <th>Bis (Zeit)</th>
          <th>Bemerkung</th>
          <th>eingetragen</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- #endregion -->

  <!-- #region 9) UNTERE HSCROLL-LEISTE ------------------------------------ -->
  <div id="bottomScroll" class="hscroll">
    <div class="hscroll__spacer"></div>
  </div>
  <!-- #endregion -->

  <!-- #region 10) SAVE-BAR (Sichern unten) -------------------------------- -->
  <div id="saveBar">
    <div class="inner">
      <button id="saveBtn" type="button">Sichern</button>
    </div>
  </div>
  <!-- #endregion -->

  <!-- #region 11) JAHRESANSICHT-CONTAINER --------------------------------- -->
  <div id="multiMonate" style="display:none;max-width:1400px;margin:20px auto;"></div>
  <!-- #endregion -->


  <!-- ====== Supabase-Anbindung: speichert/ladet das <tbody> pro Jahr+Monat ====== -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Deine Supabase-Werte (anon key ist √∂ffentlich nutzbar)
    const SUPABASE_URL = "https://gsigwwrepcafkwdvadhk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzaWd3d3JlcGNhZmt3ZHZhZGhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NjY4MzIsImV4cCI6MjA3NjI0MjgzMn0.cNNzK_OhUlMTCtUdBMxXaazQCZbf0oa0JlS7abA1Lwk";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM-Referenzen
    const tbody   = document.querySelector("#monatsTabelle tbody");
    const jahrSel = document.querySelector("#jahr");
    const monatSel= document.querySelector("#monat");
    const saveBtn = document.querySelector("#saveBtn");

    // Aktuelle Auswahl bestimmen
    function getYearMonth() {
      const now = new Date();
      const year  = parseInt(jahrSel?.value ?? now.getFullYear(), 10);
      const month = parseInt(monatSel?.value ?? now.getMonth(), 10);
      return { year, month };
    }

    // Laden aus Supabase
    async function loadTableFromSupabase() {
      const { year, month } = getYearMonth();
      const { data, error } = await supabase
        .from("monthly_html")
        .select("html")
        .eq("year", year)
        .eq("month", month)
        .maybeSingle();

      if (error) {
        console.error("Supabase SELECT Fehler:", error);
        return;
      }
      if (data?.html) {
        tbody.innerHTML = data.html;
        if (window.afterTbodyRestore) window.afterTbodyRestore();
      }
    }

    // Speichern nach Supabase (Upsert pro year+month)
    async function saveTableToSupabase() {
      const { year, month } = getYearMonth();
      const html = tbody.innerHTML;

      const { error } = await supabase
        .from("monthly_html")
        .upsert({ year, month, html })
        .select();

      if (error) {
        alert("Fehler beim Speichern: " + error.message);
        console.error(error);
        return;
      }
      if (window.showSavedToast) window.showSavedToast();
      else alert("Gespeichert.");
    }

    // Events
    if (saveBtn) {
      saveBtn.addEventListener("click", async () => {
        try { await saveTableToSupabase(); }
        catch (e) { console.error(e); alert("Unbekannter Fehler beim Speichern."); }
      });
    }
    if (monatSel) monatSel.addEventListener("change", loadTableFromSupabase);
    if (jahrSel)  jahrSel.addEventListener("change",  loadTableFromSupabase);

    // Initial nach DOM bereit laden
    document.addEventListener("DOMContentLoaded", () => {
      setTimeout(loadTableFromSupabase, 150);
    });

    // Realtime-Updates (optional, wenn mehrere gleichzeitig offen haben)
    supabase
      .channel("public:monthly_html")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "monthly_html" }, (payload) => {
        const { year, month } = getYearMonth();
        if (payload.new?.year === year && payload.new?.month === month) {
          tbody.innerHTML = payload.new.html;
          if (window.afterTbodyRestore) window.afterTbodyRestore();
        }
      })
      .on("postgres_changes", { event: "UPDATE", schema: "public", table: "monthly_html" }, (payload) => {
        const { year, month } = getYearMonth();
        if (payload.new?.year === year && payload.new?.month === month) {
          tbody.innerHTML = payload.new.html;
          if (window.afterTbodyRestore) window.afterTbodyRestore();
        }
      })
      .subscribe();
  </script>
  <!-- ========================================================================= -->
</body>
</html>
